<!doctype html>
<html lang="en-US">

	<head>
		<meta charset="utf-8">
		<title>Virgil Crypto Browser examples</title>
		<script type="text/javascript" src="/assets/virgil-crypto.browser.umd.js"></script>
		<style>
			img {
				display: block;
				max-width: 800px;
				margin: 0 auto;
			}
			input[type="file"] {
				display: block;
				margin: 40px auto;
			}
		</style>
	</head>

	<body>
		<input type="file" id="image-input" name="image" accept="image/*" />
		<img id="img" />
	<script>
		const { VirgilCrypto } = window.VirgilCrypto;
		const virgilCrypto = new VirgilCrypto();
		const keypair = getOrCreateKeyPair();

		function getOrCreateKeyPair() {
			if (localStorage.getItem('my_private_key')) {
				console.log('Loading keypair from stroage');
				const privateKey = virgilCrypto.importPrivateKey(localStorage.getItem('my_private_key'));
				const publicKey = virgilCrypto.extractPublicKey(privateKey);
				return { privateKey, publicKey };
			}

			console.log('Creating new keypair');
			const keypair = virgilCrypto.generateKeys();
			localStorage.setItem(
				'my_private_key',
				virgilCrypto.exportPrivateKey(keypair.privateKey).toString('base64')
			);
			return keypair;
		}

		function encryptAndUpload() {
			const file = this.files[0];
			const res = new Response(file);
			const reader = res.body.getReader();

			const streamCipher = virgilCrypto.createStreamCipher(keypair.publicKey);

			const encryptedChunks = [];
			encryptedChunks.push(streamCipher.start());

			next().then(() => {
				const encryptedFile = new File(encryptedChunks, file.name, { type: file.type });
				const formData = new FormData();

				formData.append('image', encryptedFile);

				fetch('/uploads', {
					method: 'POST',
					body: formData
				})
				.then(res => {
					if (res.ok) {
						return res.json();
					}

					throw new Error(`${res.status} - ${res.statusText}`);
				})
				.then(file => downloadAndDecrypt(file))
				.catch(err => console.log(err));
			});

			function next() {
				return reader.read().then(({ done, value }) => {
					if (done) {
						console.log('Finished encryption');
						encryptedChunks.push(streamCipher.final());
						return;
					}

					console.log(`Encrypting ${value.length} byte chunk`);
					encryptedChunks.push(streamCipher.update(value.buffer));
					return next();
				});
			}
		}

		function downloadAndDecrypt(fileDescriptor) {
			fetch('/uploads/' + fileDescriptor.filename)
			.then(response => {
				if (!response.ok) {
					console.error(`Server returned: ${response.status}:${response.statusText}`);
					return;
				}

				const reader = response.body.getReader();
				const streamDecipher = virgilCrypto.createStreamDecipher(keypair.privateKey);
				const decryptedChunks = [];

				next().then(() => {
					const decryptedFile = new File(decryptedChunks, fileDescriptor.originalname, { type: fileDescriptor.mimetype });
					document.getElementById('img').src = URL.createObjectURL(decryptedFile);
				});

				function next() {
					return reader.read().then(({ done, value }) => {
						if (done) {
							console.log('Finished decryption');
							decryptedChunks.push(streamDecipher.final());
							return;
						}

						console.log(`Decrypting ${value.length} byte chunk`);
						decryptedChunks.push(streamDecipher.update(value.buffer));
						return next();
					});
				}
			});
		}

		document.getElementById('image-input').addEventListener('change', encryptAndUpload);
	</script>
	</body>

</html>
